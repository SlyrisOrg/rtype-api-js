"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var _path=require("path");var _path2=_interopRequireDefault(_path);var _http=require("http");var _http2=_interopRequireDefault(_http);var _jsonwebtoken=require("jsonwebtoken");var _jsonwebtoken2=_interopRequireDefault(_jsonwebtoken);var _bodyParser=require("body-parser");var _bodyParser2=_interopRequireDefault(_bodyParser);var _express=require("express");var _express2=_interopRequireDefault(_express);var _helmet=require("helmet");var _helmet2=_interopRequireDefault(_helmet);var _morgan=require("morgan");var _morgan2=_interopRequireDefault(_morgan);var _mongodb=require("mongodb");var _mongodb2=_interopRequireDefault(_mongodb);var _winston=require("winston");var _winston2=_interopRequireDefault(_winston);var _bcrypt=require("bcrypt");var _bcrypt2=_interopRequireDefault(_bcrypt);var _dotenv=require("dotenv");var _dotenv2=_interopRequireDefault(_dotenv);var _validator=require("validator");var _validator2=_interopRequireDefault(_validator);var _nodemailer=require("nodemailer");var _nodemailer2=_interopRequireDefault(_nodemailer);var _configs=require("./modules/configs");var _configs2=_interopRequireDefault(_configs);var _logger=require("./modules/logger");var _logger2=_interopRequireDefault(_logger);var _database=require("./modules/database");var _database2=_interopRequireDefault(_database);var _verifier=require("./modules/verifier");var _verifier2=_interopRequireDefault(_verifier);var _mailer=require("./modules/mailer");var _mailer2=_interopRequireDefault(_mailer);var _messenger=require("./modules/messenger");var _messenger2=_interopRequireDefault(_messenger);var _middlewares=require("./middlewares");var _middlewares2=_interopRequireDefault(_middlewares);var _controllers=require("./controllers");var _controllers2=_interopRequireDefault(_controllers);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}_dotenv2.default.config();const configs=(0,_configs2.default)();const logger=(0,_logger2.default)({winston:_winston2.default,configs});const mailer=(0,_mailer2.default)({nodemailer:_nodemailer2.default,configs});process.on("SIGINT",()=>{logger.info("Application exit");process.exit(0)});process.on("SIGTERM",()=>{logger.warn("Application interupted");process.exit(0)});process.on("uncaughtException",err=>{logger.error("Caught exception:",err);process.exit(1)});process.on("unhandledRejection",(reason,p)=>{logger.error("Unhandled Rejection at:",p,"and reason:",reason);process.exit(1)});const app=(0,_express2.default)();try{app.engine("js",(0,_messenger2.default)({configs}));app.set("view engine","js");app.set("views",_path2.default.resolve(process.cwd(),"src","views"));const database=(0,_database2.default)({mongo:_mongodb2.default,bcrypt:_bcrypt2.default,jwt:_jsonwebtoken2.default,configs});const verifier=(0,_verifier2.default)({validator:_validator2.default,configs});app.use((0,_middlewares2.default)({configs,logger,bcrypt:_bcrypt2.default,helmet:_helmet2.default,bodyParser:_bodyParser2.default,morgan:_morgan2.default,path:_path2.default,express:_express2.default},_express2.default.Router()));app.use((0,_controllers2.default)({logger,jwt:_jsonwebtoken2.default,database,verifier,configs,express:_express2.default},_express2.default.Router()));const server=_http2.default.createServer(app);server.listen(configs.server.port,()=>logger.info("Application launched on",configs.server.env));server.on("err",err=>{if(err.syscall!=="listen"){throw new Error(err)}const bind=typeof configs.server.port==="string"?`Pipe ${configs.server.port}`:`Port ${configs.server.port}`;switch(err.code){case"EACCES":throw new Error(`${bind} port requires elevated privileges`);case"EADDRINUSE":throw new Error(`${bind} port is already in use`);default:throw err;}});server.on("listening",()=>{const addr=server.address();const bind=typeof addr==="string"?`pipe ${addr}`:`port ${addr.port}`;logger.info("Application listening on",bind)})}catch(err){logger.error("Application failure:",err);mailer.alert(err)}exports.default=app;