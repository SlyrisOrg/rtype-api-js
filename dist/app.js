"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var _fs=require("fs");var _fs2=_interopRequireDefault(_fs);var _path=require("path");var _path2=_interopRequireDefault(_path);var _http=require("http");var _http2=_interopRequireDefault(_http);var _jsonwebtoken=require("jsonwebtoken");var _jsonwebtoken2=_interopRequireDefault(_jsonwebtoken);var _bodyParser=require("body-parser");var _bodyParser2=_interopRequireDefault(_bodyParser);var _express=require("express");var _express2=_interopRequireDefault(_express);var _helmet=require("helmet");var _helmet2=_interopRequireDefault(_helmet);var _morgan=require("morgan");var _morgan2=_interopRequireDefault(_morgan);var _mongodb=require("mongodb");var _mongodb2=_interopRequireDefault(_mongodb);var _winston=require("winston");var _winston2=_interopRequireDefault(_winston);var _bcrypt=require("bcrypt");var _bcrypt2=_interopRequireDefault(_bcrypt);var _dotenv=require("dotenv");var _dotenv2=_interopRequireDefault(_dotenv);var _validator=require("validator");var _validator2=_interopRequireDefault(_validator);var _nodemailer=require("nodemailer");var _nodemailer2=_interopRequireDefault(_nodemailer);var _configs=require("./modules/configs");var _configs2=_interopRequireDefault(_configs);var _logger=require("./modules/logger");var _logger2=_interopRequireDefault(_logger);var _database=require("./modules/database");var _database2=_interopRequireDefault(_database);var _verifier=require("./modules/verifier");var _verifier2=_interopRequireDefault(_verifier);var _mailer=require("./modules/mailer");var _mailer2=_interopRequireDefault(_mailer);var _guid=require("./modules/guid");var _guid2=_interopRequireDefault(_guid);var _signature=require("./middlewares/signature");var _signature2=_interopRequireDefault(_signature);var _messenger=require("./middlewares/messenger");var _messenger2=_interopRequireDefault(_messenger);var _user=require("./controllers/user");var _user2=_interopRequireDefault(_user);var _server=require("./configs/server");var _server2=_interopRequireDefault(_server);var _database3=require("./configs/database");var _database4=_interopRequireDefault(_database3);var _message=require("./configs/message");var _message2=_interopRequireDefault(_message);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}const guid=(0,_guid2.default)();const configs=(0,_configs2.default)({dotenv:_dotenv2.default},{server:_server2.default,database:_database4.default,message:_message2.default});const logger=(0,_logger2.default)({winston:_winston2.default},configs);const database=(0,_database2.default)({mongo:_mongodb2.default,bcrypt:_bcrypt2.default,jwt:_jsonwebtoken2.default},configs);const verifier=(0,_verifier2.default)({validator:_validator2.default},configs);const mailer=(0,_mailer2.default)({nodemailer:_nodemailer2.default},configs);const signature=(0,_signature2.default)({bcrypt:_bcrypt2.default},configs);const messenger=(0,_messenger2.default)({guid},configs);const app=(0,_express2.default)();app.engine("js",messenger);process.on("SIGINT",()=>{logger.info("Application exit");process.exit(0)});process.on("SIGTERM",()=>{logger.warn("Application interupted");process.exit(0)});process.on("uncaughtException",err=>{logger.error("Caught exception:",err);process.exit(1)});process.on("unhandledRejection",(reason,p)=>{logger.error("Unhandled Rejection at:",p,"and reason:",reason);process.exit(1)});try{app.set("views",_path2.default.resolve(process.cwd(),"src","views"));app.use((req,res,next)=>{res.set("Content-Type","application/json");next()});app.use((0,_helmet2.default)());app.use(_helmet2.default.hpkp({maxAge:7776000,sha256s:["AbCdEf123=","ZyXwVu456="]}));app.use(_helmet2.default.contentSecurityPolicy({directives:{defaultSrc:["'self'"],styleSrc:["'self'"]}}));app.use(_helmet2.default.noCache());app.use(signature);app.use(_bodyParser2.default.urlencoded({extended:!0,defer:!0}));app.use(_bodyParser2.default.json({type:"*/*"}));app.use((error,req,res,next)=>{if(error instanceof SyntaxError){res.render("error",configs.message.badRequest.payload);return}next()});app.use((0,_morgan2.default)("combined",{stream:{write:message=>logger.info(message)}}));app.use((req,res,next)=>{logger.debug(req.body);next()});app.use("/",_express2.default.static(_path2.default.resolve(process.cwd(),"public")));app.use("/api/user",(0,_user2.default)({logger,jwt:_jsonwebtoken2.default,database,verifier},configs)(_express2.default.Router()));app.use("*",(req,res)=>{res.render("error",configs.message.notFound.payload)});const server=_http2.default.createServer(app);server.listen(configs.server.port,()=>logger.info("Application launched on",configs.server.env));server.on("err",err=>{if(err.syscall!=="listen"){throw new Error(err)}const bind=typeof configs.server.port==="string"?`Pipe ${configs.server.port}`:`Port ${configs.server.port}`;switch(err.code){case"EACCES":throw new Error(`${bind} port requires elevated privileges`);case"EADDRINUSE":throw new Error(`${bind} port is already in use`);default:throw err;}});server.on("listening",()=>{const addr=server.address();const bind=typeof addr==="string"?`pipe ${addr}`:`port ${addr.port}`;logger.info("Application listening on",bind)})}catch(err){logger.error("Application failure:",err);mailer.alert(err)}exports.default=app;